/**
 * @file graphics.cu
 * @brief Defines the functions for displaying an X11 render of the simulation.
 *
 * This file provides the definition of functions for initializing an X11 window and
 * updating the window based on the simulation's current state.
 *
 * Project originally by:
 * David Joiner
 *
 * Modified by:
 * Steven McKelvey - Calvin University, January 2025
 *
 * NOTE: This project's function documentation was generated by ChatGPT on August 22nd, 2024.
 *          Keep in mind that there may be errors and the documentation may not be 100% accurate.
 */

#include "graphics.cuh"

/**
 * @brief Global variables for managing the X11 display and graphics context.
 * 
 * These variables are used to handle the X11 window, color settings, and graphical output.
 */
Display *dpy_x11;               ///< Pointer to the X11 display.
int black_x11;                  ///< Black pixel value.
int white_x11;                  ///< White pixel value.
Window w_x11;                   ///< X11 window identifier.
GC gc_x11;                      ///< Graphics context for X11.
Pixmap buffer_x11;              ///< Pixmap used for double buffering.
Colormap theColormap_x11;       ///< Color map for X11.
int numXGrayscale_x11 = 10;     ///< Number of grayscale levels.
XColor XGrayscale_x11[10];      ///< Array of grayscale colors.
int width_x11 = 800;            ///< Width of the X11 window.
int height_x11 = 400;           ///< Height of the X11 window.
int window_created_x11 = 0;     ///< Flag indicating if the window has been created.

/**
 * @brief Sets up the X11 window and graphics context.
 * 
 * This function initializes the X11 display, creates a window, sets up the color map, 
 * and prepares the graphics context for drawing. The window is created with the specified
 * width and height.
 * 
 * @param IMAGE_WIDTH The width of the window to be created.
 * @param IMAGE_HEIGHT The height of the window to be created.
 */
void setupWindow(int IMAGE_WIDTH, int IMAGE_HEIGHT)
{
    int i, color;

    dpy_x11 = XOpenDisplay(getDisplay());
    assert(dpy_x11);

    black_x11 = BlackPixel(dpy_x11, DefaultScreen(dpy_x11));
    white_x11 = WhitePixel(dpy_x11, DefaultScreen(dpy_x11));

    w_x11 = XCreateSimpleWindow(dpy_x11, DefaultRootWindow(dpy_x11), 0, 0,
                                IMAGE_WIDTH, IMAGE_HEIGHT, 0, black_x11,
                                black_x11);
    buffer_x11 = XCreatePixmap(dpy_x11, DefaultRootWindow(dpy_x11),
                               IMAGE_WIDTH, IMAGE_HEIGHT, DefaultDepth(dpy_x11, DefaultScreen(dpy_x11)));
    theColormap_x11 = XCreateColormap(dpy_x11, DefaultRootWindow(dpy_x11),
                                      DefaultVisual(dpy_x11, DefaultScreen(dpy_x11)), AllocNone);

    // Create grayscale colors
    for (i = 0; i < numXGrayscale_x11; ++i)
    {
        color = (int)((double)i * 35535.0 / (double)(numXGrayscale_x11 - 1)) + 30000;
        XGrayscale_x11[i].red = color;
        XGrayscale_x11[i].green = color;
        XGrayscale_x11[i].blue = color;
        XAllocColor(dpy_x11, theColormap_x11, &(XGrayscale_x11[i]));
    }

    XSelectInput(dpy_x11, w_x11, StructureNotifyMask);
    XMapWindow(dpy_x11, w_x11);
    gc_x11 = XCreateGC(dpy_x11, w_x11, 0, NIL);
    XSetForeground(dpy_x11, gc_x11, white_x11);

    // Wait for the window to be mapped
    for (;;)
    {
        XEvent e;
        XNextEvent(dpy_x11, &e);
        if (e.type == MapNotify)
            break;
    }
}

/**
 * @brief Renders the current state of the N-body model to the X11 window.
 * 
 * This function scales and shifts the positions of the bodies in the model, maps their 
 * coordinates to the screen, and draws them in grayscale based on their depth.
 * 
 * @param theModel A pointer to the NbodyModel structure containing the current state of the system.
 */
void make_image(NbodyModel *theModel)
{
    int i;
    double scale, shift;
    int dispX, dispY, dispZ, depthY, depthZ;

    // Clear the buffer
    XSetForeground(dpy_x11, gc_x11, black_x11);
    XFillRectangle(dpy_x11, buffer_x11, gc_x11,
                   0, 0, width_x11, height_x11);

    scale = (double)height_x11 / (2.0 * theModel->default_scale);
    shift = (double)width_x11 / 4.0;
    
    // Draw each body in the model
    for (i = 0; i < theModel->num_bodies; ++i)
    {
        dispX = (int)(scale * theModel->x[i] + shift);
        dispY = (int)(scale * theModel->y[i] + shift);
        dispZ = (int)(scale * theModel->z[i] + shift);

        depthY = (int)((double)dispY / (double)height_x11 * numXGrayscale_x11);
        depthY = depthY < 0 ? 0 : (depthY >= numXGrayscale_x11 ? numXGrayscale_x11 - 1 : depthY);

        depthZ = (int)((double)dispZ / (double)height_x11 * numXGrayscale_x11);
        depthZ = depthZ < 0 ? 0 : (depthZ >= numXGrayscale_x11 ? numXGrayscale_x11 - 1 : depthZ);


        if (dispX < width_x11 / 2)
        {
            XSetForeground(dpy_x11, gc_x11, XGrayscale_x11[depthZ].pixel);
            XFillRectangle(dpy_x11, buffer_x11, gc_x11, dispX, dispY, 3, 3);
        }
        if (dispX > 0)
        {
            XSetForeground(dpy_x11, gc_x11, XGrayscale_x11[depthY].pixel);
            XFillRectangle(dpy_x11, buffer_x11, gc_x11,
                           dispX + width_x11 / 2, dispZ, 3, 3);
        }
    }

    // Copy the buffer to the window and display it
    XCopyArea(dpy_x11, buffer_x11, w_x11, gc_x11, 0, 0,
              width_x11, height_x11, 0, 0);
    XFlush(dpy_x11);
}

/**
 * @brief Updates the N-body model and renders it to the display.
 * 
 * This function checks if the X11 window has been created, and if not, it sets it up. 
 * It then calls `make_image` to render the current state of the model.
 * 
 * @param theModel A pointer to the NbodyModel structure containing the current state of the system.
 * @return int Returns 1 on success.
 */
int updateNbodyModel(NbodyModel *theModel)
{
    // Ensure the window is created before rendering
    if (!window_created_x11)
    {
        setupWindow(width_x11, height_x11);
        window_created_x11 = 1;
    }

    // Render the current state of the model
    make_image(theModel);

    return 1;
}