/**
 * @file galaxsee.c
 * @brief Includes the main function for running the N-body simulation
 *
 * This file includes a main function that:
 * - Defines the initial conditions for the simulation
 * - Reads the command line arguments given by the user
 * - Runs the simulation
 * - Outputs the results
 *
 * Project originally by:
 * David Joiner
 *
 * Modified by:
 * Steven McKelvey - Calvin University, August 2024
 *
 * NOTE: This project's function documentation was generated by ChatGPT on August 22nd, 2024.
 *          Keep in mind that there may be errors and the documentation may not be 100% accurate.
 */

#include "nbody.h"
#include "stepModel.h"
#include "graphics.h"
#include <time.h>
#include <mpi.h>

// Sets up the N-body model with default settings and initial conditions.
void setupModel(NbodyModel *theModel, int num_bodies, double rotation_factor, double initial_v);

// MPI Variables. Made available for extern use.
MPI_Status status;
int rank;
int size;

int main(int argc, char **argv) {
    NbodyModel *theModel = NULL; // Pointer to the N-body model
    int num_bodies = 500;        // Default number of bodies in the simulation
    double tStep = 8.0;          // Time step for each simulation iteration (1.0 by default)
    double tFinal = 20000.0;      // Final simulation time (1000.0 by default)
    int count_updates = 0;       // Counter for simulation updates
    int skip_updates = 1;        // Controls how often the display updates
    int show_display = 1;        // Flag to control whether to show the display
    double rotation_factor = 1.0;// Factor influencing the rotational velocity of bodies
    double initial_v = 0.0;      // Initial velocity for bodies
    time_t begin;                // Time at the start of the simulation
    time_t end;                  // Time at the end of the simulation

    time(&begin); // Record the start time

    // Command line argument parsing
    printf("USAGE: program_name num_bodies t_final rotation_factor initial_v show_display\n");
    int i = 0;
    if (argc > ++i) {
        sscanf(argv[i], "%d", &num_bodies);
    }
    if (argc > ++i) {
        sscanf(argv[i], "%lf", &tFinal);
    }
    if (argc > ++i) {
        sscanf(argv[i], "%lf", &rotation_factor);
    }
    if (argc > ++i) {
        sscanf(argv[i], "%lf", &initial_v);
    }
    if (argc > ++i) {
        sscanf(argv[i], "%d", &show_display);
    }

    // Display the model summary
    printf("Model Summary\n");
    printf("num_bodies = %d\n", num_bodies);
    printf("tFinal = %lf\n", tFinal);
    printf("rotation_factor = %lf\n", rotation_factor);
    printf("initial_v = %lf\n", initial_v);

    // Allocate memory for the N-body model
    theModel = allocateNbodyModel(num_bodies);

    srand(0); // Seed the random number generator for reproducibility

    // Main simulation loop
    setupModel(theModel, num_bodies, rotation_factor, initial_v);
    while (theModel->t < tFinal) {
        // Advance the simulation by one time step
        stepNbodyModel(theModel, tStep);

        // Update the display periodically based on skip_updates
        if ((count_updates++) % skip_updates == 0 && show_display) {
            updateNbodyModel(theModel); // Visual update using X11
        }
    }

    time(&end); // Record the end time

    // Display the elapsed wall time for the simulation
    printf("Wall Time Elapsed = %8.lf seconds\n", difftime(end, begin));

    // Pause the program so the user can view the final output
    // https://stackoverflow.com/questions/9386651/pause-screen-at-program-completion-in-c
    printf("Press any key to continue...\n");
    getchar(); // Wait for user input before closing

    // Free the memory allocated for the N-body model
    freeNbodyModel(theModel);

    return 0;
}

/**
 * @brief Sets up the N-body model with default settings and initial conditions.
 *
 * @param theModel Pointer to the NbodyModel.
 * @param num_bodies Number of bodies in the simulation.
 * @param rotation_factor Factor to apply rotational spin to the system.
 * @param initial_v Initial velocity to apply to the bodies.
 *
 * This function configures the NbodyModel by setting default values for scale, 
 * mass, gravitational constant, and initializing the bodies' positions and velocities.
 * It also applies a rotational spin and initial velocities to the system.
 */
void setupModel(NbodyModel *theModel, int num_bodies, double rotation_factor, double initial_v) {
    if (theModel != NULL) {
        freeNbodyModel(theModel); // Free existing model memory, if any
    }
    theModel = allocateNbodyModel(num_bodies); // Allocate new memory for the model
    setScaleNbodyModel(theModel, 800.0); // Set spatial scale (parsecs)
    setMassNbodyModel(theModel, 200000.0 / (double)num_bodies); // Set mass (solar masses)
    setGNbodyModel(theModel, 0.0046254); // Set gravitational constant (pc^3/solar_mass/My^2)
    initializeNbodyModel(theModel); // Initialize model (positions, velocities)
    spinNbodyModel(theModel, rotation_factor); // Apply rotational spin
    speedNbodyModel(theModel, initial_v); // Apply initial velocities
}
